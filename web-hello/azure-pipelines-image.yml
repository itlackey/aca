# Azure DevOps pipeline: Build, push and image-only deploy for web-hello
#
# This pipeline builds the container image, pushes it to ACR and then
# updates the existing container app by changing only the image.  It
# triggers on changes to the application source code or Dockerfile.

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - src/*
      - Dockerfile
      - azure-pipelines-image.yml

pr: none

pool:
  vmImage: ubuntu-latest

variables:
  # Name of the Azure service connection used by AzureCLI@2
  azureSubscription: 'aca-apps-service-connection'

  # Resource identifiers (should be set via variable groups or the UI)
  ACR_NAME:         'acaregistrydemo1234'
  ACR_LOGIN_SERVER: 'acaregistrydemo1234.azurecr.io'
  RESOURCE_GROUP:   'rg-aca-platform-demo'
  ACA_ENVIRONMENT:  'aca-env-demo'
  APP_NAME:         'web-hello-main'
  SUBSCRIPTION_ID:  '00000000-0000-0000-0000-000000000000'

stages:
  - stage: BuildAndDeploy
    displayName: Build image and perform image-only deployment
    jobs:
      - job: Build
        displayName: Build, push and update
        steps:
          - checkout: self
            clean: true

          - task: AzureCLI@2
            displayName: Build, push and deploy image only
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail

                echo "Logging in to ACR $(ACR_NAME)"
                az acr login --name "$(ACR_NAME)"

                IMAGE_TAG=$(Build.SourceVersion)
                IMAGE="$(ACR_LOGIN_SERVER)/$(APP_NAME):${IMAGE_TAG}"
                echo "Using image: $IMAGE"

                docker build -t "$IMAGE" .
                docker push "$IMAGE"

                echo "SUBSCRIPTION_ID=$(SUBSCRIPTION_ID)" > .env
                echo "RESOURCE_GROUP=$(RESOURCE_GROUP)" >> .env
                echo "ACA_ENVIRONMENT=$(ACA_ENVIRONMENT)" >> .env
                echo "APP_NAME=$(APP_NAME)" >> .env
                echo "IMAGE=$IMAGE" >> .env

                chmod +x scripts/deploy-image-only.sh
                ./scripts/deploy-image-only.sh