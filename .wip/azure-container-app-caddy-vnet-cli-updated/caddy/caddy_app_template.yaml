# Template for the Caddy container app YAML definition.
#
# This YAML file is used by the deployment scripts to create the Caddy
# reverse‑proxy container app using the Azure CLI.  It includes the
# following components:
#  - managedEnvironmentId: the resource ID of the Container Apps
#    environment where the app will be deployed.
#  - configuration.ingress: exposes port 80 with external ingress.
#  - template.containers: defines the Caddy container, its image,
#    environment variables for backend hostnames and resource limits,
#    and the volume mount for the Caddy configuration.
#  - template.volumes: declares the volume that maps to an Azure Files
#    share defined at the environment level.  The name must match
#    the storage definition created via `az containerapp env storage set`.
#
# Placeholders surrounded by double curly braces (e.g. {{ENV_ID}}) will
# be replaced at runtime by the deployment script.

location: {{LOCATION}}
properties:
  managedEnvironmentId: {{ENV_ID}}
  configuration:
    ingress:
      external: true
      targetPort: 80
      # Allow insecure HTTP connections so that ACME HTTP‑01 challenges can
      # be completed when Caddy provisions certificates.  Without this
      # setting, Azure Container Apps automatically redirects HTTP to
      # HTTPS, which would prevent Caddy from serving the challenge
      # responses.  See https://learn.microsoft.com/en-us/azure/container-apps/ingress-how-to#ingress-settings
      allowInsecure: true
  template:
    containers:
      - name: {{CADDY_APP_NAME}}
        image: caddy:2.7
        env:
          - name: APP1_HOST
            value: {{APP1_FQDN}}
          - name: APP2_HOST
            value: {{APP2_FQDN}}
          # The public domain used for certificate provisioning.  This
          # value is injected by the deployment script from the .env file.
          - name: PUBLIC_DOMAIN
            value: {{PUBLIC_DOMAIN}}
          # Email address used by Caddy when registering for ACME
          # certificates.  This value is injected by the deployment script.
          - name: LETS_ENCRYPT_EMAIL
            value: {{LETS_ENCRYPT_EMAIL}}
          # Override the XDG data home so that Caddy's certificate and
          # account data are stored on the mounted Azure File share.  By
          # pointing this to the same path as the config mount, we ensure
          # that certificate state is persisted across revisions and
          # restarts.
          - name: XDG_DATA_HOME
            value: /etc/caddy
        resources:
          cpu: 0.5
          memory: 1.0Gi
        volumeMounts:
          - mountPath: /etc/caddy
            volumeName: caddy-config
    scale:
      minReplicas: 1
      maxReplicas: 3
    volumes:
      - name: caddy-config
        storageType: AzureFile
        storageName: {{STORAGE_NAME}}